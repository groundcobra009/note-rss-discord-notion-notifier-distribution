<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('Styles'); ?>
</head>
<body>
  <div class="dialog-content">
    <!-- ç¾åœ¨ã®ãƒˆãƒªã‚¬ãƒ¼çŠ¶æ…‹ -->
    <div class="trigger-status" id="triggerStatus">
      <div class="trigger-status-icon" id="triggerStatusIcon">
        â°
      </div>
      <div class="trigger-status-text">
        <div class="label">ç¾åœ¨ã®è¨­å®š</div>
        <div class="value" id="triggerStatusText">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <span class="status-badge" id="triggerBadge">ç¢ºèªä¸­</span>
    </div>

    <!-- å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
    <div class="section">
      <h3 class="section-title">å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰</h3>
      <div class="section-content">
        <div class="radio-group">
          <label class="radio-label" id="modeHourlyLabel">
            <input type="radio" name="triggerMode" value="hourly" onchange="updateTriggerMode()">
            <div>
              <strong>å®šæœŸå®Ÿè¡Œ</strong>
              <p class="help-text">æŒ‡å®šã—ãŸæ™‚é–“é–“éš”ã§è‡ªå‹•å®Ÿè¡Œ</p>
            </div>
          </label>
          <label class="radio-label" id="modeDailyLabel">
            <input type="radio" name="triggerMode" value="daily" onchange="updateTriggerMode()">
            <div>
              <strong>æ¯æ—¥å®Ÿè¡Œ</strong>
              <p class="help-text">æ¯æ—¥æŒ‡å®šæ™‚åˆ»ã«1å›å®Ÿè¡Œ</p>
            </div>
          </label>
        </div>
      </div>
    </div>

    <!-- å®šæœŸå®Ÿè¡Œè¨­å®š -->
    <div class="section" id="hourlySettings" style="display: none;">
      <h3 class="section-title">å®Ÿè¡Œé–“éš”</h3>
      <div class="section-content">
        <div class="form-group">
          <select class="select-field" id="hourlyInterval">
            <option value="1">1æ™‚é–“ã”ã¨</option>
            <option value="2">2æ™‚é–“ã”ã¨</option>
            <option value="3">3æ™‚é–“ã”ã¨</option>
            <option value="6">6æ™‚é–“ã”ã¨</option>
            <option value="12">12æ™‚é–“ã”ã¨</option>
            <option value="24">24æ™‚é–“ã”ã¨</option>
          </select>
        </div>
      </div>
    </div>

    <!-- æ¯æ—¥å®Ÿè¡Œè¨­å®š -->
    <div class="section" id="dailySettings" style="display: none;">
      <h3 class="section-title">å®Ÿè¡Œæ™‚åˆ»</h3>
      <div class="section-content">
        <div class="form-group">
          <select class="select-field" id="dailyHour">
            <option value="0">0:00</option>
            <option value="1">1:00</option>
            <option value="2">2:00</option>
            <option value="3">3:00</option>
            <option value="4">4:00</option>
            <option value="5">5:00</option>
            <option value="6">6:00</option>
            <option value="7">7:00</option>
            <option value="8">8:00</option>
            <option value="9" selected>9:00</option>
            <option value="10">10:00</option>
            <option value="11">11:00</option>
            <option value="12">12:00</option>
            <option value="13">13:00</option>
            <option value="14">14:00</option>
            <option value="15">15:00</option>
            <option value="16">16:00</option>
            <option value="17">17:00</option>
            <option value="18">18:00</option>
            <option value="19">19:00</option>
            <option value="20">20:00</option>
            <option value="21">21:00</option>
            <option value="22">22:00</option>
            <option value="23">23:00</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="statusMessage" class="alert" style="display: none;"></div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ -->
    <div class="dialog-footer">
      <button class="btn btn-secondary" onclick="deleteTrigger()" id="deleteBtn">
        ğŸ—‘ï¸ ãƒˆãƒªã‚¬ãƒ¼å‰Šé™¤
      </button>
      <button class="btn btn-primary" onclick="createTrigger()" id="createBtn">
        âœ… ãƒˆãƒªã‚¬ãƒ¼ä½œæˆ
      </button>
    </div>
  </div>

  <script>
    /**
     * å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
     */
    function updateTriggerMode() {
      const mode = document.querySelector('input[name="triggerMode"]:checked');
      
      // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
      document.querySelectorAll('input[name="triggerMode"]').forEach(radio => {
        const label = radio.closest('.radio-label');
        label.classList.toggle('selected', radio.checked);
      });

      if (!mode) {
        document.getElementById('hourlySettings').style.display = 'none';
        document.getElementById('dailySettings').style.display = 'none';
        return;
      }

      if (mode.value === 'hourly') {
        document.getElementById('hourlySettings').style.display = 'block';
        document.getElementById('dailySettings').style.display = 'none';
      } else {
        document.getElementById('hourlySettings').style.display = 'none';
        document.getElementById('dailySettings').style.display = 'block';
      }
    }

    /**
     * ãƒˆãƒªã‚¬ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
     */
    function loadTriggerInfo() {
      google.script.run
        .withSuccessHandler(function(info) {
          const statusText = document.getElementById('triggerStatusText');
          const statusIcon = document.getElementById('triggerStatusIcon');
          const badge = document.getElementById('triggerBadge');

          if (info.exists) {
            statusIcon.classList.add('active');
            statusIcon.classList.remove('inactive');
            badge.className = 'status-badge active';
            badge.textContent = 'æœ‰åŠ¹';

            if (info.interval) {
              statusText.textContent = `${info.interval}æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ`;
              document.querySelector('input[name="triggerMode"][value="hourly"]').checked = true;
              document.getElementById('hourlyInterval').value = info.interval;
            } else if (info.hour !== null) {
              statusText.textContent = `æ¯æ—¥ ${info.hour}:00 ã«å®Ÿè¡Œ`;
              document.querySelector('input[name="triggerMode"][value="daily"]').checked = true;
              document.getElementById('dailyHour').value = info.hour;
            } else {
              statusText.textContent = 'ãƒˆãƒªã‚¬ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™';
            }
          } else {
            statusIcon.classList.add('inactive');
            statusIcon.classList.remove('active');
            badge.className = 'status-badge inactive';
            badge.textContent = 'ç„¡åŠ¹';
            statusText.textContent = 'ãƒˆãƒªã‚¬ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
          }

          updateTriggerMode();
        })
        .withFailureHandler(function(error) {
          document.getElementById('triggerStatusText').textContent = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
          showStatus('ãƒˆãƒªã‚¬ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .getTriggerInfo();
    }

    /**
     * ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆ
     */
    function createTrigger() {
      const mode = document.querySelector('input[name="triggerMode"]:checked');
      
      if (!mode) {
        showStatus('å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      const btn = document.getElementById('createBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> ä½œæˆä¸­...';

      let intervalType = mode.value;
      let intervalValue;

      if (intervalType === 'hourly') {
        intervalValue = parseInt(document.getElementById('hourlyInterval').value);
      } else {
        intervalValue = parseInt(document.getElementById('dailyHour').value);
      }

      google.script.run
        .withSuccessHandler(function(result) {
          btn.disabled = false;
          btn.innerHTML = 'âœ… ãƒˆãƒªã‚¬ãƒ¼ä½œæˆ';
          
          if (result.success) {
            showStatus(result.message, 'success');
            loadTriggerInfo();
          } else {
            showStatus(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.innerHTML = 'âœ… ãƒˆãƒªã‚¬ãƒ¼ä½œæˆ';
          showStatus('ãƒˆãƒªã‚¬ãƒ¼ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .createTimeTrigger(intervalType, intervalValue);
    }

    /**
     * ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤
     */
    function deleteTrigger() {
      const btn = document.getElementById('deleteBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> å‰Šé™¤ä¸­...';

      google.script.run
        .withSuccessHandler(function(result) {
          btn.disabled = false;
          btn.innerHTML = 'ğŸ—‘ï¸ ãƒˆãƒªã‚¬ãƒ¼å‰Šé™¤';
          
          if (result.success) {
            showStatus(result.message, 'success');
            loadTriggerInfo();
          } else {
            showStatus(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.innerHTML = 'ğŸ—‘ï¸ ãƒˆãƒªã‚¬ãƒ¼å‰Šé™¤';
          showStatus('ãƒˆãƒªã‚¬ãƒ¼å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .deleteTrigger();
    }

    /**
     * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
     */
    function showStatus(message, type) {
      const status = document.getElementById('statusMessage');
      status.className = 'alert alert-' + type;
      status.textContent = message;
      status.style.display = 'block';
      
      setTimeout(() => {
        status.style.display = 'none';
      }, 5000);
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      loadTriggerInfo();
    });
  </script>
</body>
</html>

