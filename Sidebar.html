<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('Styles'); ?>
</head>
<body>
  <!-- èªè¨¼æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="section">
    <h3 class="section-title">ğŸ” èªè¨¼æƒ…å ±</h3>
    <div class="section-content">
      <!-- Discord Webhook URL -->
      <div class="form-group">
        <label class="form-label" for="discordWebhookUrl">Discord Webhook URL</label>
        <div class="input-with-toggle">
          <input
            type="password"
            id="discordWebhookUrl"
            class="input-field"
            placeholder="https://discord.com/api/webhooks/..."
            aria-label="Discord Webhook URL"
          >
          <button
            type="button"
            class="toggle-visibility"
            onclick="toggleVisibility('discordWebhookUrl')"
            aria-label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ"
          >
            <span class="eye-icon">ğŸ‘</span>
          </button>
        </div>
        <div class="test-row">
          <button class="btn btn-sm btn-outline" onclick="testDiscord()" id="testDiscordBtn">
            æ¥ç¶šãƒ†ã‚¹ãƒˆ
          </button>
          <span id="discordTestResult" class="test-result"></span>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Notion API Key -->
      <div class="form-group">
        <label class="form-label" for="notionApiKey">Notion API Key</label>
        <div class="input-with-toggle">
          <input
            type="password"
            id="notionApiKey"
            class="input-field"
            placeholder="secret_..."
            aria-label="Notion API Key"
          >
          <button
            type="button"
            class="toggle-visibility"
            onclick="toggleVisibility('notionApiKey')"
            aria-label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ"
          >
            <span class="eye-icon">ğŸ‘</span>
          </button>
        </div>
      </div>

      <!-- Notion Database ID -->
      <div class="form-group">
        <label class="form-label" for="notionDatabaseId">Notion ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ID</label>
        <div class="input-with-toggle">
          <input
            type="password"
            id="notionDatabaseId"
            class="input-field"
            placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
            aria-label="Notion ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ID"
          >
          <button
            type="button"
            class="toggle-visibility"
            onclick="toggleVisibility('notionDatabaseId')"
            aria-label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ"
          >
            <span class="eye-icon">ğŸ‘</span>
          </button>
        </div>
        <div class="test-row">
          <button class="btn btn-sm btn-outline" onclick="testNotion()" id="testNotionBtn">
            æ¥ç¶šãƒ†ã‚¹ãƒˆ
          </button>
          <span id="notionTestResult" class="test-result"></span>
        </div>
      </div>

      <!-- Notion Page URL (å›ºå®šãƒªãƒ³ã‚¯) -->
      <div class="form-group">
        <label class="form-label" for="notionPageUrl">Notion å›ºå®šãƒªãƒ³ã‚¯ï¼ˆä»»æ„ï¼‰</label>
        <input
          type="text"
          id="notionPageUrl"
          class="input-field"
          placeholder="https://www.notion.so/..."
          aria-label="Notion å›ºå®šãƒªãƒ³ã‚¯"
        >
        <p class="help-text">Discordé€šçŸ¥ã«è¡¨ç¤ºã™ã‚‹Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ãƒªãƒ³ã‚¯</p>
      </div>
    </div>
  </div>

  <!-- LINEè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="section">
    <h3 class="section-title">ğŸ’¬ LINEé€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</h3>
    <div class="section-content">
      <p class="help-text" style="margin-bottom:12px;">
        LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®Messaging APIã‚’ä½¿ç”¨ã—ã¾ã™ã€‚LINE Notifyã¯å»ƒæ­¢æ¸ˆã¿ã§ã™ã€‚
      </p>

      <!-- LINE Channel Access Token -->
      <div class="form-group">
        <label class="form-label" for="lineChannelAccessToken">ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³</label>
        <div class="input-with-toggle">
          <input
            type="password"
            id="lineChannelAccessToken"
            class="input-field"
            placeholder="é•·æœŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›..."
            aria-label="LINE ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³"
          >
          <button
            type="button"
            class="toggle-visibility"
            onclick="toggleVisibility('lineChannelAccessToken')"
            aria-label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ"
          >
            <span class="eye-icon">ğŸ‘</span>
          </button>
        </div>
        <p class="help-text">LINE Developers Console â†’ Messaging API â†’ ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆé•·æœŸï¼‰</p>
      </div>

      <!-- LINE User ID -->
      <div class="form-group">
        <label class="form-label" for="lineUserId">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
        <div class="input-with-toggle">
          <input
            type="password"
            id="lineUserId"
            class="input-field"
            placeholder="Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
            aria-label="LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼ID"
          >
          <button
            type="button"
            class="toggle-visibility"
            onclick="toggleVisibility('lineUserId')"
            aria-label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ"
          >
            <span class="eye-icon">ğŸ‘</span>
          </button>
        </div>
        <p class="help-text">LINE Developers Console â†’ ãƒãƒ£ãƒãƒ«åŸºæœ¬è¨­å®š â†’ ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</p>
      </div>

      <div class="test-row">
        <button class="btn btn-sm btn-outline" onclick="testLine()" id="testLineBtn">
          æ¥ç¶šãƒ†ã‚¹ãƒˆ
        </button>
        <span id="lineTestResult" class="test-result"></span>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="section">
    <h3 class="section-title">ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</h3>
    <div class="section-content">
      <!-- ãƒ¡ãƒ¼ãƒ«é€šçŸ¥æœ‰åŠ¹/ç„¡åŠ¹ -->
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¼ãƒ«é€šçŸ¥</label>
        <div class="radio-group horizontal">
          <label class="radio-label" id="emailEnabled1Label">
            <input type="radio" name="emailEnabled" value="1" onchange="updateEmailRadioStyle()">
            æœ‰åŠ¹
          </label>
          <label class="radio-label" id="emailEnabled0Label">
            <input type="radio" name="emailEnabled" value="0" onchange="updateEmailRadioStyle()" checked>
            ç„¡åŠ¹
          </label>
        </div>
      </div>

      <!-- é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼‰ -->
      <div class="form-group">
        <label class="form-label" for="emailTo">é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <div class="input-with-toggle">
          <input
            type="password"
            id="emailTo"
            class="input-field"
            placeholder="example@gmail.com"
            aria-label="é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
          >
          <button
            type="button"
            class="toggle-visibility"
            onclick="toggleVisibility('emailTo')"
            aria-label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ"
          >
            <span class="eye-icon">ğŸ‘</span>
          </button>
        </div>
        <p class="help-text">ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å®‰å…¨ã«ä¿å­˜ã•ã‚Œã¾ã™</p>
      </div>

      <!-- ãƒ¡ãƒ¼ãƒ«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼‰ -->
      <div class="form-group">
        <label class="form-label" for="emailPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰</label>
        <div class="input-with-toggle">
          <input
            type="password"
            id="emailPassword"
            class="input-field"
            placeholder="Gmailã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰"
            aria-label="ãƒ¡ãƒ¼ãƒ«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
          >
          <button
            type="button"
            class="toggle-visibility"
            onclick="toggleVisibility('emailPassword')"
            aria-label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ"
          >
            <span class="eye-icon">ğŸ‘</span>
          </button>
        </div>
        <p class="help-text">ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å®‰å…¨ã«ä¿å­˜ã•ã‚Œã¾ã™</p>
      </div>

      <!-- ãƒ¡ãƒ¼ãƒ«ä»¶åãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
      <div class="form-group">
        <label class="form-label" for="emailSubject">ä»¶åãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
        <input
          type="text"
          id="emailSubject"
          class="input-field"
          placeholder="ã€noteæ–°ç€ã€‘æœ¬æ—¥ã®æ–°ç€è¨˜äº‹ {count}ä»¶"
          aria-label="ãƒ¡ãƒ¼ãƒ«ä»¶åãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ"
        >
        <p class="help-text">{count} {date} ãŒä½¿ãˆã¾ã™ï¼ˆãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆå½¢å¼ï¼‰</p>
      </div>

      <div class="test-row">
        <button class="btn btn-sm btn-outline" onclick="testEmail()" id="testEmailBtn">
          ãƒ†ã‚¹ãƒˆé€ä¿¡
        </button>
        <span id="emailTestResult" class="test-result"></span>
      </div>
    </div>
  </div>

  <!-- é€šçŸ¥è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="section">
    <h3 class="section-title">âš™ï¸ é€šçŸ¥è¨­å®š</h3>
    <div class="section-content">
      <div class="form-group">
        <label class="form-label">å–å¾—æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿</label>
        <div class="radio-group horizontal">
          <label class="radio-label" id="filterDays1Label">
            <input type="radio" name="filterDays" value="1" onchange="updateRadioStyle()">
            1æ—¥ä»¥å†…
          </label>
          <label class="radio-label" id="filterDays3Label">
            <input type="radio" name="filterDays" value="3" onchange="updateRadioStyle()">
            3æ—¥ä»¥å†…
          </label>
          <label class="radio-label" id="filterDays7Label">
            <input type="radio" name="filterDays" value="7" onchange="updateRadioStyle()">
            7æ—¥ä»¥å†…
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- å®Ÿè¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="section">
    <h3 class="section-title">â–¶ï¸ è¨˜äº‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ</h3>
    <div class="section-content">
      <div class="btn-group vertical">
        <button class="btn btn-primary btn-block" onclick="runCheck(0)" id="runAllBtn">
          â–¶ï¸ ä»Šã™ãå®Ÿè¡Œï¼ˆå…¨ã¦ï¼‰
        </button>
        <button class="btn btn-outline btn-block" onclick="runCheck(1)" id="run1DayBtn">
          ğŸ“… 1æ—¥ä»¥å†…ã®è¨˜äº‹ã‚’ãƒã‚§ãƒƒã‚¯
        </button>
        <button class="btn btn-outline btn-block" onclick="runCheck(3)" id="run3DayBtn">
          ğŸ“… 3æ—¥ä»¥å†…ã®è¨˜äº‹ã‚’ãƒã‚§ãƒƒã‚¯
        </button>
        <button class="btn btn-outline btn-block" onclick="runCheck(7)" id="run7DayBtn">
          ğŸ“† 7æ—¥ä»¥å†…ã®è¨˜äº‹ã‚’ãƒã‚§ãƒƒã‚¯
        </button>
      </div>
      <div id="runResult" class="test-result" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="section">
    <h3 class="section-title">ğŸ“‹ ç®¡ç†</h3>
    <div class="section-content">
      <div class="btn-group vertical">
        <button class="btn btn-primary btn-block" onclick="saveSettings()" id="saveBtn">
          ğŸ’¾ è¨­å®šã‚’ä¿å­˜
        </button>
        <button class="btn btn-secondary btn-block" onclick="openTriggerDialog()">
          â° ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
        </button>
        <button class="btn btn-secondary btn-block" onclick="openHowToUse()">
          ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰
        </button>
      </div>
    </div>
  </div>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div id="statusMessage" class="alert" style="display: none;"></div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒªãƒ³ã‚¯ -->
  <div class="footer-links">
    <a class="footer-link" onclick="setupSheets()">
      ğŸš€ åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚·ãƒ¼ãƒˆä½œæˆï¼‰
    </a>
  </div>

  <script>
    // è‡ªå‹•ãƒã‚¹ã‚¯ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†
    let autoMaskTimers = {};

    /**
     * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º/éè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
     */
    function toggleVisibility(inputId) {
      const input = document.getElementById(inputId);
      const isPassword = input.type === 'password';
      input.type = isPassword ? 'text' : 'password';

      // è‡ªå‹•å†ãƒã‚¹ã‚¯ï¼ˆ10ç§’å¾Œï¼‰
      if (isPassword) {
        clearTimeout(autoMaskTimers[inputId]);
        autoMaskTimers[inputId] = setTimeout(() => {
          input.type = 'password';
        }, 10000);
      } else {
        clearTimeout(autoMaskTimers[inputId]);
      }
    }

    /**
     * ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
     */
    function updateRadioStyle() {
      const radios = document.querySelectorAll('input[name="filterDays"]');
      radios.forEach(radio => {
        const label = radio.closest('.radio-label');
        if (radio.checked) {
          label.classList.add('selected');
        } else {
          label.classList.remove('selected');
        }
      });
    }

    /**
     * ãƒ¡ãƒ¼ãƒ«æœ‰åŠ¹/ç„¡åŠ¹ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
     */
    function updateEmailRadioStyle() {
      const radios = document.querySelectorAll('input[name="emailEnabled"]');
      radios.forEach(radio => {
        const label = radio.closest('.radio-label');
        label.classList.toggle('selected', radio.checked);
      });
    }

    /**
     * è¨­å®šã‚’èª­ã¿è¾¼ã¿
     */
    function loadSettings() {
      google.script.run
        .withSuccessHandler(function(settings) {
          document.getElementById('discordWebhookUrl').value = settings.discordWebhookUrl || '';
          document.getElementById('notionApiKey').value = settings.notionApiKey || '';
          document.getElementById('notionDatabaseId').value = settings.notionDatabaseId || '';
          document.getElementById('notionPageUrl').value = settings.notionPageUrl || '';

          // LINEè¨­å®šï¼ˆãƒã‚¹ã‚¯å€¤ã‚’è¡¨ç¤ºï¼‰
          document.getElementById('lineChannelAccessToken').value = settings.lineChannelAccessToken || '';
          document.getElementById('lineUserId').value = settings.lineUserId || '';

          // ãƒ¡ãƒ¼ãƒ«è¨­å®š
          var emailEnabledRadio = document.querySelector('input[name="emailEnabled"][value="' + (settings.emailEnabled || '0') + '"]');
          if (emailEnabledRadio) {
            emailEnabledRadio.checked = true;
            updateEmailRadioStyle();
          }
          document.getElementById('emailTo').value = settings.emailTo || '';
          document.getElementById('emailPassword').value = settings.emailPassword || '';
          document.getElementById('emailSubject').value = settings.emailSubject || '';

          // ãƒ•ã‚£ãƒ«ã‚¿æ—¥æ•°
          const filterDays = settings.filterDays || '1';
          const radio = document.querySelector('input[name="filterDays"][value="' + filterDays + '"]');
          if (radio) {
            radio.checked = true;
            updateRadioStyle();
          }
        })
        .withFailureHandler(showError)
        .getAllSettings();
    }

    /**
     * è¨­å®šã‚’ä¿å­˜
     */
    function saveSettings() {
      const btn = document.getElementById('saveBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> ä¿å­˜ä¸­...';

      const filterDaysRadio = document.querySelector('input[name="filterDays"]:checked');
      const emailEnabledRadio = document.querySelector('input[name="emailEnabled"]:checked');

      const settings = {
        discordWebhookUrl: document.getElementById('discordWebhookUrl').value.trim(),
        notionApiKey: document.getElementById('notionApiKey').value.trim(),
        notionDatabaseId: document.getElementById('notionDatabaseId').value.trim(),
        notionPageUrl: document.getElementById('notionPageUrl').value.trim(),
        filterDays: filterDaysRadio ? filterDaysRadio.value : '1',
        lineChannelAccessToken: document.getElementById('lineChannelAccessToken').value.trim(),
        lineUserId: document.getElementById('lineUserId').value.trim(),
        emailEnabled: emailEnabledRadio ? emailEnabledRadio.value : '0',
        emailTo: document.getElementById('emailTo').value.trim(),
        emailPassword: document.getElementById('emailPassword').value.trim(),
        emailSubject: document.getElementById('emailSubject').value.trim()
      };

      google.script.run
        .withSuccessHandler(function(result) {
          btn.disabled = false;
          btn.innerHTML = 'ğŸ’¾ è¨­å®šã‚’ä¿å­˜';
          showStatus(result.message, 'success');
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.innerHTML = 'ğŸ’¾ è¨­å®šã‚’ä¿å­˜';
          showError(error);
        })
        .saveAllSettings(settings);
    }

    /**
     * Discordæ¥ç¶šãƒ†ã‚¹ãƒˆ
     */
    function testDiscord() {
      const btn = document.getElementById('testDiscordBtn');
      const result = document.getElementById('discordTestResult');

      // ã¾ãšè¨­å®šã‚’ä¿å­˜
      const webhookUrl = document.getElementById('discordWebhookUrl').value.trim();
      google.script.run.saveSettings('DISCORD_WEBHOOK_URL', webhookUrl);

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>';
      result.className = 'test-result loading';
      result.textContent = 'ãƒ†ã‚¹ãƒˆä¸­...';
      result.style.display = 'inline-block';

      google.script.run
        .withSuccessHandler(function(res) {
          btn.disabled = false;
          btn.innerHTML = 'æ¥ç¶šãƒ†ã‚¹ãƒˆ';
          result.className = 'test-result ' + (res.success ? 'success' : 'error');
          result.textContent = res.message;
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.innerHTML = 'æ¥ç¶šãƒ†ã‚¹ãƒˆ';
          result.className = 'test-result error';
          result.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        })
        .testDiscordWebhook();
    }

    /**
     * Notionæ¥ç¶šãƒ†ã‚¹ãƒˆ
     */
    function testNotion() {
      const btn = document.getElementById('testNotionBtn');
      const result = document.getElementById('notionTestResult');

      // ã¾ãšè¨­å®šã‚’ä¿å­˜
      const apiKey = document.getElementById('notionApiKey').value.trim();
      const databaseId = document.getElementById('notionDatabaseId').value.trim();
      google.script.run.saveSettings('NOTION_API_KEY', apiKey);
      google.script.run.saveSettings('NOTION_DATABASE_ID', databaseId);

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>';
      result.className = 'test-result loading';
      result.textContent = 'ãƒ†ã‚¹ãƒˆä¸­...';
      result.style.display = 'inline-block';

      google.script.run
        .withSuccessHandler(function(res) {
          btn.disabled = false;
          btn.innerHTML = 'æ¥ç¶šãƒ†ã‚¹ãƒˆ';
          result.className = 'test-result ' + (res.success ? 'success' : 'error');
          result.textContent = res.message;
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.innerHTML = 'æ¥ç¶šãƒ†ã‚¹ãƒˆ';
          result.className = 'test-result error';
          result.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        })
        .testNotionConnection();
    }

    /**
     * LINEæ¥ç¶šãƒ†ã‚¹ãƒˆ
     */
    function testLine() {
      const btn = document.getElementById('testLineBtn');
      const result = document.getElementById('lineTestResult');

      // ã¾ãšLINEè¨­å®šã‚’ä¿å­˜
      var token = document.getElementById('lineChannelAccessToken').value.trim();
      var userId = document.getElementById('lineUserId').value.trim();
      if (token && token !== '********') {
        google.script.run.saveLineSettings(token, userId);
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>';
      result.className = 'test-result loading';
      result.textContent = 'ãƒ†ã‚¹ãƒˆä¸­...';
      result.style.display = 'inline-block';

      google.script.run
        .withSuccessHandler(function(res) {
          btn.disabled = false;
          btn.innerHTML = 'æ¥ç¶šãƒ†ã‚¹ãƒˆ';
          result.className = 'test-result ' + (res.success ? 'success' : 'error');
          result.textContent = res.message;
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.innerHTML = 'æ¥ç¶šãƒ†ã‚¹ãƒˆ';
          result.className = 'test-result error';
          result.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        })
        .testLineConnection();
    }

    /**
     * ãƒ¡ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆé€ä¿¡
     */
    function testEmail() {
      const btn = document.getElementById('testEmailBtn');
      const result = document.getElementById('emailTestResult');

      // ã¾ãšãƒ¡ãƒ¼ãƒ«è¨­å®šã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä¿å­˜
      var emailTo = document.getElementById('emailTo').value.trim();
      var emailPassword = document.getElementById('emailPassword').value.trim();
      if (emailTo && emailTo !== '********') {
        google.script.run.saveAllSettings({ emailTo: emailTo, emailPassword: emailPassword });
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>';
      result.className = 'test-result loading';
      result.textContent = 'é€ä¿¡ä¸­...';
      result.style.display = 'inline-block';

      google.script.run
        .withSuccessHandler(function(res) {
          btn.disabled = false;
          btn.innerHTML = 'ãƒ†ã‚¹ãƒˆé€ä¿¡';
          result.className = 'test-result ' + (res.success ? 'success' : 'error');
          result.textContent = res.message;
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.innerHTML = 'ãƒ†ã‚¹ãƒˆé€ä¿¡';
          result.className = 'test-result error';
          result.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        })
        .testEmailNotification();
    }

    /**
     * è¨˜äº‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
     */
    function runCheck(filterDays) {
      var btnIds = ['runAllBtn', 'run1DayBtn', 'run3DayBtn', 'run7DayBtn'];
      var btnMap = { 0: 'runAllBtn', 1: 'run1DayBtn', 3: 'run3DayBtn', 7: 'run7DayBtn' };
      var activeBtn = document.getElementById(btnMap[filterDays]);
      var originalText = activeBtn.innerHTML;
      var result = document.getElementById('runResult');

      // å…¨ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      btnIds.forEach(function(id) { document.getElementById(id).disabled = true; });
      activeBtn.innerHTML = '<span class="spinner"></span> å®Ÿè¡Œä¸­...';
      result.className = 'test-result loading';
      result.textContent = 'è¨˜äº‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™...';
      result.style.display = 'block';

      google.script.run
        .withSuccessHandler(function(res) {
          btnIds.forEach(function(id) { document.getElementById(id).disabled = false; });
          activeBtn.innerHTML = originalText;
          result.className = 'test-result success';
          result.textContent = res.message;
          setTimeout(function() { result.style.display = 'none'; }, 5000);
        })
        .withFailureHandler(function(error) {
          btnIds.forEach(function(id) { document.getElementById(id).disabled = false; });
          activeBtn.innerHTML = originalText;
          result.className = 'test-result error';
          result.textContent = error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
          setTimeout(function() { result.style.display = 'none'; }, 5000);
        })
        .runCheckFromSidebar(filterDays || null);
    }

    /**
     * ãƒˆãƒªã‚¬ãƒ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
     */
    function openTriggerDialog() {
      google.script.run.openTriggerDialog();
    }

    /**
     * ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã‚’é–‹ã
     */
    function openHowToUse() {
      google.script.run.openHowToUse();
    }

    /**
     * åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚·ãƒ¼ãƒˆä½œæˆï¼‰
     */
    function setupSheets() {
      google.script.run
        .withSuccessHandler(function(result) {
          showStatus(result.message, 'success');
        })
        .withFailureHandler(showError)
        .setupAllSheets();
    }

    /**
     * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
     */
    function showStatus(message, type) {
      const status = document.getElementById('statusMessage');
      status.className = 'alert alert-' + type;
      status.textContent = message;
      status.style.display = 'block';

      setTimeout(() => {
        status.style.display = 'none';
      }, 5000);
    }

    /**
     * ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
     */
    function showError(error) {
      showStatus(error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      loadSettings();
    });
  </script>
</body>
</html>
